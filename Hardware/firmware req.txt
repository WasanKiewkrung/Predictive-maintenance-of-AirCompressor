timestamp
{
  "timestamp": "YYYY-MM-DD HH:MM:SS.ms",
  "ax": float,
  "ay": float,
  "az": float,
  "temp": float,
  "amp": float,
  "rul_predict": float,
  "status": int (0=Normal, 1=Abnormal)
}

backend

import asyncio
import json
import threading
from typing import List
from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from fastapi.middleware.cors import CORSMiddleware
import paho.mqtt.client as mqtt
from . import database  # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ database.py ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°

app = FastAPI()

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ MQTT (Config) ---
# ‡πÉ‡∏ä‡πâ Public Broker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
MQTT_BROKER = "test.mosquitto.org"
MQTT_PORT = 1883
MQTT_TOPIC = "factory/compressor/data" 

# ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Loop ‡∏Ç‡∏≠‡∏á Asyncio (‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏° Thread)
main_loop = None

# --- 2. Setup CORS ---
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- 3. Connection Manager (WebSocket Hub ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Frontend) ---
class ConnectionManager:
    def __init__(self):
        self.active_connections: List[WebSocket] = []

    async def connect(self, websocket: WebSocket):
        await websocket.accept()
        self.active_connections.append(websocket)

    def disconnect(self, websocket: WebSocket):
        self.active_connections.remove(websocket)

    async def broadcast(self, data: dict):
        for connection in self.active_connections:
            try:
                await connection.send_json(data)
            except Exception:
                pass

manager = ConnectionManager()

# --- 4. MQTT Client Setup (‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å NXP Board) ---
mqtt_client = mqtt.Client()

def on_connect(client, userdata, flags, rc):
    print(f"üì° MQTT Connected with result code {rc}")
    client.subscribe(MQTT_TOPIC)
    print(f"üëÇ Subscribed to topic: {MQTT_TOPIC}")

def on_message(client, userdata, msg):
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà NXP Board ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏ó‡∏≤‡∏á MQTT
    """
    try:
        # 1. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MQTT (Bytes) ‡πÄ‡∏õ‡πá‡∏ô Dictionary (Python)
        payload = msg.payload.decode()
        data = json.loads(payload)
        
        # print(f"üì• Received: {data}") # Debug ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà

        # 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Database (SQLite)
        # (Database ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Auto Cleanup ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô logic ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
        database.insert_data_sqlite(data)

        # 3. ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ Frontend (Bridge Logic)
        # ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ MQTT ‡∏£‡∏±‡∏ô‡∏Ñ‡∏ô‡∏•‡∏∞ Thread ‡∏Å‡∏±‡∏ö FastAPI ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
        if main_loop and main_loop.is_running():
            asyncio.run_coroutine_threadsafe(manager.broadcast(data), main_loop)
            
    except json.JSONDecodeError:
        print("‚ö†Ô∏è Error: Received non-JSON data from MQTT")
    except Exception as e:
        print(f"‚ö†Ô∏è Error processing MQTT message: {e}")

# ‡∏ú‡∏π‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Callback ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß Client
mqtt_client.on_connect = on_connect
mqtt_client.on_message = on_message

# --- 5. Startup / Shutdown Events ---
@app.on_event("startup")
async def startup_event():
    global main_loop
    # ‡πÄ‡∏Å‡πá‡∏ö Loop ‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏° Thread
    main_loop = asyncio.get_running_loop()
    
    # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Database
    database.init_db()
    print("‚úÖ System Ready: Database Initialized.")

    # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT (Non-blocking)
    try:
        mqtt_client.connect(MQTT_BROKER, MQTT_PORT, 60)
        mqtt_client.loop_start() # ‡∏£‡∏±‡∏ô‡πÉ‡∏ô Background Thread
        print("üöÄ MQTT Client Started")
    except Exception as e:
        print(f"‚ùå Failed to connect to MQTT Broker: {e}")

@app.on_event("shutdown")
async def shutdown_event():
    # ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î Server
    mqtt_client.loop_stop()
    mqtt_client.disconnect()
    print("üõë MQTT Client Stopped")

# --- 6. WebSocket Endpoint (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Frontend ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ---
@app.websocket("/ws/frontend")
async def websocket_frontend(websocket: WebSocket):
    await manager.connect(websocket)
    print("üíª Frontend Joined Dashboard")
    try:
        while True:
            # ‡∏£‡∏≠‡∏£‡∏±‡∏ö Ping/Pong ‡∏à‡∏≤‡∏Å Frontend ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤ Connection
            await websocket.receive_text() 
    except WebSocketDisconnect:
        manager.disconnect(websocket)
        print("üíª Frontend Left Dashboard")

@app.get("/")
def read_root():
    return {
        "status": "Online", 
        "mode": "Production (MQTT Real Data)", 
        "broker": MQTT_BROKER,
        "topic": MQTT_TOPIC
    }

database

import sqlite3
import os
from datetime import datetime, timedelta

# ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå Database ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏ö
DB_NAME = "maintenance_logs.db"

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á SQLite (‡πÄ‡∏Å‡πá‡∏ö Log ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Web Dashboard) ---

def init_db():
    """‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô Database ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Status 0/1)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS sensor_summary (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            timestamp DATETIME,
            ax REAL, ay REAL, az REAL, 
            temp REAL, amp REAL, 
            rul_predict REAL,
            status INTEGER
        )
    ''')
    conn.commit()
    conn.close()

def insert_data_sqlite(data):
    """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á SQLite"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    
    cursor.execute('''
        INSERT INTO sensor_summary (timestamp, ax, ay, az, temp, amp, rul_predict, status)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    ''', (
        data['timestamp'], 
        data['ax'], data['ay'], data['az'], 
        data['temp'], data['amp'], 
        data['rul_predict'],
        data['status']
    ))
    
    conn.commit()
    conn.close()

def cleanup_old_sqlite_data():
    """‡∏•‡∏ö Log ‡πÉ‡∏ô Database ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 7 ‡∏ß‡∏±‡∏ô"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    
    # ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô
    cursor.execute("DELETE FROM sensor_summary WHERE timestamp < datetime('now', '-7 days')")
    
    deleted_count = cursor.rowcount
    if deleted_count > 0:
        print(f"üßπ History Cleaner: Removed {deleted_count} old records.")
        
    conn.commit()
    conn.close()
